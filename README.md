# **RuseLoRaWAN - EMU**

#### **Лиценз на разпространиение**
 - MIT License към съдържанието на хранилището.
 - Този проект е собственост на "Starup Factory" - Русе

#### **Съдържание**

 - [Опорна документация](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9E%D0%BF%D1%80%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8F)
 - [Описание](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9E%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5)
 - [Приготовление](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9F%D1%80%D0%B8%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5)
 - [Електрическа схема](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%95%D0%BB%D0%B5%D0%BA%D1%82%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0-%D1%81%D1%85%D0%B5%D0%BC%D0%B0)
 - [Приготовление на средата](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9F%D1%80%D0%B8%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BD%D0%B0-%D1%81%D1%80%D0%B5%D0%B4%D0%B0%D1%82%D0%B0)
 - [Програмиране на Adafruit Feather](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%B8%D1%80%D0%B0%D0%BD%D0%B5-%D0%BD%D0%B0-adafruit-feather)
 - [Свързване на устройството към мрежата на TTN](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%A1%D0%B2%D1%8A%D1%80%D0%B7%D0%B2%D0%B0%D0%BD%D0%B5-%D0%BD%D0%B0-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE%D1%82%D0%BE-%D0%BA%D1%8A%D0%BC-%D0%BC%D1%80%D0%B5%D0%B6%D0%B0%D1%82%D0%B0-%D0%BD%D0%B0-ttn)
 - [Свързване на TTN устройство с Cayenne myDevices](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%A1%D0%B2%D1%8A%D1%80%D0%B7%D0%B2%D0%B0%D0%BD%D0%B5-%D0%BD%D0%B0-ttn-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE-%D1%81-cayenne-mydevices)
 - [Картографиране на свързаността](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9A%D0%B0%D1%80%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%80%D0%B0%D0%BD%D0%B5-%D0%BD%D0%B0-%D1%81%D0%B2%D1%8A%D1%80%D0%B7%D0%B0%D0%BD%D0%BE%D1%81%D1%82%D1%82%D0%B0)
 - [Проби](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%9F%D1%80%D0%BE%D0%B1%D0%B8)
 - [Задачи](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8)
 - [Решения](https://github.com/startupfactorybg/RuseLoRaWAN#%D0%A0%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D1%8F)

#### **Опорна документация**
 - [Какво е Arduino](https://www.arduino.cc/en/Main/Software)
 - [Какво е Adafruit Feather 32u4 LoRa](https://www.adafruit.com/product/3078)
 - [Какво е TTN](https://www.thethingsnetwork.org/docs/)
 - [Какво е Cayenne myDevices](https://mydevices.com/cayenne/docs/intro/)
 - [Какво е Cayenne LPP](https://www.thethingsnetwork.org/docs/devices/arduino/api/cayennelpp.html)
 - [Как да свържем Adafruit Feather 32u4 LoRa с TTN](https://www.thethingsnetwork.org/labs/story/using-adafruit-feather-32u4-rfm95-as-an-ttn-node/step/introduction)
 - [Спецификация на ATMega32u4](http://ww1.microchip.com/downloads/en/devicedoc/atmel-7766-8-bit-avr-atmega16u4-32u4_datasheet.pdf)
 - [Калкулатор за 1/4 вълнови резонатор с вертикална поляризация](https://m0ukd.com/calculators/quarter-wave-ground-plane-antenna-calculator/)
 - [Изводи на Adafruit Feather 32u4 LoRa](https://cdn-learn.adafruit.com/assets/assets/000/046/201/original/feather_32u4_LoRa_v1.3.pdf?1504806229)
 - [Сензор BMP280](https://www.adafruit.com/product/2651)

#### **Описание**
- Този пример е подходящ за хора, които знаят какво е TTN. В случай, че не се чувствате уверени в това, мола посетете следната стрница: [**Документация**](https://www.thethingsnetwork.org/docs/)
- Това е само пример как да използвате Adafruit Feather 32u4 RFM95 в мрежата на TTN. Ето и повече информация за самото устройство, което ще свържем към TTN: [**Документация**](https://learn.adafruit.com/adafruit-feather-32u4-radio-with-lora-radio-module)

#### **Приготовление**
 - За да използваме LoRa/RFM95 възможностите на това устройство е необходимо да свържете ~6 и IO1:

| Feather  | RFM95  |
| ----------- |:-------:|
| ~6          | IO1      |

_Таблица 1_

![](https://ttnstaticfile.blob.core.windows.net/media/django-summernote/2017-08-08/b132cae3-4101-4b65-94bf-06598e4177fc.png)

_Фигура 1_


 - Свържете проводник с дължина 82.1 mm, този размер е 1/4 от дължината на вълната при честота 868MHz. Която е позволената LoRa четотна лента за Европа. Калкулацията за сверяване на вашите входни данни, може да извършите със следния онлайн [**Калкулатор**](https://learn.adafruit.com/adafruit-feather-32u4-radio-with-lora-radio-module) . В този случай ще използваме само вертикално поляризираният излъчващ елемент. Виж фиг. 1.

| Параметър | Мерна Единица | Стойност |
|-----------|-----------|:-------:|
|Честота|MHz|868|
|Скорост на разпространение||0,95|
|Дължина на вълната|mm|345,6|
|(A)Вертикално поляризиран излъчващ елемент (λ*0,25)*vf|mm|82,1|
|(B)Радиалани ребра (λ*0,28)*vf|mm|91,9|

_Таблица 2_

![](https://m0ukd.com/static/calculators/Quarter_Wave_Ground_Plane/Quarter_Wave_Drawing.png)

_Фигура 2_

#### **Електрическа схема**
 - Модел на свързванене на компонентите на устройството.
![](https://raw.githubusercontent.com/startupfactorybg/RuseLoRaWAN/master/Schematics/EMU/EMU_bb.png)

_Фигура 3_

 - Електрическа схема на устройството
![](https://raw.githubusercontent.com/startupfactorybg/RuseLoRaWAN/master/Schematics/EMU/EMU_schem.png)

_Фигура 4_

 - Електрическа схема на Feather 32u4 LoRa
![](https://cdn-learn.adafruit.com/assets/assets/000/031/658/original/feather_schem.png?1460518302)

_Фигура 5_

#### **Приготовление на средата**
 - Ако сте се запознали с устройството и неговата документация описани в точка 1 "Описание", то следващата [**Стъпка**](https://learn.adafruit.com/adafruit-feather-32u4-radio-with-lora-radio-module/using-with-arduino-ide) няма да представлява трудност за вас. В тази стъпка настройваме средата за работа с устройството.
 - След като сме инсталирали всичко необходимо, за да програмиране нашето устройство следва да добавим библиотеката [**LMIC**](https://github.com/matthijskooijman/arduino-lmic) за работа с LoRa стека. Добавянето става, като изтеглим архив от връзката и го разархивираме в C:\Users\ "ВашиятПотребител"\Documents\Arduino\libraries\lmic. След като сте я разархивирали е редно да рестартирате Arduino приложението, за да може средата да възприеме новата библиотека.
 - За да може следващата библиотека да работи е необходимо да инсталираме една основна. Добавянето става, като изтеглим [**Aрхив от връзката**](https://github.com/bencpeters/node-adafruit-sensor) и го разархивираме в C:\Users\ “ВашиятПотребител”\Documents\Arduino\libraries\Adafruit_Sensor-master. След като сте я разархивирали е редно да рестартирате Arduino приложението, за да може средата да възприеме новата библиотека. 
 - Поради особенности на проекта е решено да се използва BMP280 сензор за примерни измервания, в тази подточка ще дадем указания как се инсталира тази библиотека. Добавянето става, като изтеглим [**Aрхив от връзката**](https://github.com/adafruit/Adafruit_BMP280_Library) и го разархивираме в C:\Users\ “ВашиятПотребител”\Documents\Arduino\libraries\Adafruit_BMP280_Library. След като сте я разархивирали е редно да рестартирате Arduino приложението, за да може средата да възприеме новата библиотека.
 - След инсталирането на библиотеките за работа с LoRa/TTN и BM280 идва ред на библиотека, която отговаря за пакетирането на информацията от сензорите. Библиотеката се казва CayenneLPP. Ето и [**Връзка към документцацията**](https://www.thethingsnetwork.org/docs/devices/arduino/api/cayennelpp.html). Добавянето става, като изтеглим [**Aрхив от връзката**](https://github.com/sabas1080/CayenneLPP) и го разархивираме в C:\Users\ “ВашиятПотребител”\Documents\Arduino\libraries\CayenneLPP. След като сте я разархивирали е редно да рестартирате Arduino приложението, за да може средата да възприеме новата библиотека.
 - В случай, че има смели хора, в нашият списък със задачи от точка 6, малко по-надолу в този документ има задача, която е свързана с дълбоко приспиване на устройството. Един от вариантите за решаването ѝ е свързано с [**Тази библиотека**](https://github.com/adafruit/Adafruit_SleepyDog).  Добавянето става, като изтеглим [**Aрхив от връзката**](https://github.com/adafruit/Adafruit_SleepyDog) и го разархивираме в C:\Users\ “ВашиятПотребител”\Documents\Arduino\libraries\Adafruit_SleepyDog_Library. След като сте я разархивирали е редно да рестартирате Arduino приложението, за да може средата да възприеме новата библиотека.

#### **Програмиране на Adafruit Feather**
 - Програмирането на устройството е лесно, като да програмираш обикновенно Ардуино. Който се е запознал документацията описана в точка 1 "Описание" за него няма тайни. 
 - Първото най-важно нещо е да настроим правилно вашата среда - От менюто "Tools" -> "Board" -> Избираме Adafruit Feather 32u4.
 - След като сме избрали модела на своето устройстово е необходимо да изберем комуникационият порт на устройството - От менюто "Tools" -> "Port" -> COMx (Adafruit Feather 32u4).
 - Следва да сте свързани с вашето устройство.
 - Моля натиснете Verifie и се убедете, че всичко се компилира коректно.
 - Ако е коректно, е ред да сложите в кода си вашите уникални ключове за сесията, приложението и номера на вашето устройство.
 - След добавянена тези ключове устройството, Ви, е готово за работа и следващи модификации.

#### **Свързване на устройството към мрежата на TTN**
 - В точка "Опорна документация" е разяснено какво е TTN, много е важно преди да програмира устройството вече да познавате начина на работа на TTN.
 - За да продължим напред с регистрацията на устройство в мрежата на TTN, е много важно да си създадем потребителски профил в [**този портал**](https://www.thethingsnetwork.org/).
 - Нека да поясним, че устройството в текущият проект работи в режим Activation by Personalization (ABP). Това ще рече, че устройството е предварително оторизирано за свръзка с мрежата на TTN.
 - За свързването на устройството с мрежата са необходими няколко неща. 3-те най-основни се наричат: Network Sesion Key - или сесиен ключ, Application Sesion Key - или ключ на приложението, и Device Address - или уникален адрес на устройството. Поради факта, че устройтвото е в ABP режим на свръзка, това означава, че при регистрация на устройството в мрежата на TTN, самият TTN издава тези 3 номера. Номерата са в 16-тичен вид и след генериране са скрити, до момента на тяхното копиране и поставяне в програмният код на устройството.
 - Поставянето на тези 3 номера в програмният код става като заменим 3-те константи в [**основният програмен файл**](https://github.com/startupfactorybg/RuseLoRaWAN/blob/master/StartupFactoryEMU/StartupFactoryEMU/StartupFactoryEMU.ino). Константите се наричат:
__static const PROGMEM u1_t NWKSKEY[16]__,
__static const u1_t PROGMEM APPSKEY[16]__,
__static const u4_t DEVADDR__
 - След успешното добавяне на тези номера проверете дали програмният код се компилира, и ако да го заредете в устройстовото.
 - След успешно зареждане на кода влезте в TTN портала отворете страницата на устройството, ресетирайте брояча на пакети и започнете да следите има ли активност на пакети в мрежата на TTN. Ако да, това означава, че вие успешно сте добавили и свързали устройството към мрежата на TTN.

#### **Свързване на TTN устройство с Cayenne myDevices**
 - В точка "Опорна документация" е разяснено какво е Cayenne, много е важно преди да програмира устройството вече да познавате начина на работа на TTN.
 - За да продължим напред с регистрацията на устройство в мрежата на TTN, е много важно да си създадем потребителски профил
 - Cayenne на myDevices е услуга, която позволява на вас като разработчик и потребител да извършвате активен и пасивен мониторинг върху вашите устройства.
 - Активен мониторинг е процеса на постоянно наблюдение на самите устройтва от страна на операторите. Cayenne Позволява това да се случи, като предлага приятен за потребителя WEB-базиран интерфейс, подходящ както за големи монитори, така и за мобилни устройства - таблети и мобилни телефони. 
 - Пасивен мониторинг е процеса, когато системата за мониторинг ви напомня за това, че се слува определен процес или събитие. Важността на процеса или събитието, го определя контекста на системата. В Cayenne това се реализира, чрез e-mail известия (notifications) или заявка до определен URL (WEB hooks). Вторият метод позволява веригообразно свързване на една с друга услуга. Това позволява свързването на "устройтвата" с вече готови сиситеми или портали за управление на процеси.
 - Начина на добавяне на TTN устройство в таблото за наблюдение на Cayenne става чрез натискане на "Add new ..." -> "Device Widget" - > "LoRa" -> "The Things Network" -> "Cayenne LPP".
 - В дясната половина на браузъра ви ще се появи малка форма в която трябва да попълните едно поле "DevEUI".
 - Полето "DevEUI" се взема като копирате DevEUI от страницата на създаденото устройтво полето Device EUI и го поставите в Cayenne полето.
 - Поради факта, че комуникацията е двустранна от другата страна интеграцията продължава, като в влезете в "Devices" -> "Integrations" и добавите "Cayenne".
 - Последната стъпка на интегриране е да се уточни формата на пренасяните данни или Paylod format. Това става, като отидете в таба "Payload" и изберете "Cayenne LPP".
 - С това вашата интеграция завърши. Ако всичко е минало гладко в полето на устройството ще се появят различни утреди и показатели, които ще визуализират данните от устройството.
 - **В този случай ще се появят - 
 RRSI - Канал 100 в сила на сеигнала в деци Бели [dB];
 SNR - Канал 101 отношение на сила на сигнала към шум в деци Бели [dB];
 Temperature (1) - Канал 1 в градуси по Целзии [C];
 Barometter (2) - Канал 2 в мм живачен стълб [mm/Hg];
 Battery (3) - Канал 3 в напрежение на батерията [V];
 GPS (4) - Канал 4, GPS кординати с карта.**
 - Частта от кода, която отговаря за изпращане на тези данни е се намира в [**основният програмен файл**](https://github.com/startupfactorybg/RuseLoRaWAN/blob/master/StartupFactoryEMU/StartupFactoryEMU/StartupFactoryEMU.ino) във функция __void do_send(osjob_t* j)__.

#### **Картографиране на свързаността**
 - Картографирането е важна стъпка в изграждането на една мрежа. Информацията, която носи този процес е свързана с това колко е силен сигнала в различните географски точки. С други думи получаваме карта на силата на сигнала в рамките на обхвата на съответният гейт. Към момента TTN предлага [**пиложение**](https://play.google.com/store/apps/details?id=com.jpmeijers.ttnmapper&rdid=com.jpmeijers.ttnmapper), което след свързване то директно показва силата на сигнала.
 - Процеса по картографиране е структуриран по следният начин. Създаваме крайно устройство, което изпраща данни на равни интервали от време, например една минута. След получаване на данните от страна на гейта, те пристигат в приложението на мобилния телефон или таблет, с който ги визуализираме. Получените данни се комбинират в данните от GPS Модула в мобилното устройство телефон или таблет. Комбинираните данни се изпращат в централен сървар на TTN, където се съхраняват и използват от други поребители. Има вариант в, който устройството изпраща данни при подаден от нас сигнал, чрез натискане на бутон. В първият случай измерваме постоянно. Ако се движим с постоянна скорост, ще получим равномерна карта на покритието. Във вторият случай можем да измерваме силата в конкретни географски точки по заявка.
 - Приложението, което следва да използваме за тази цел се намира [**тук**](https://play.google.com/store/apps/details?id=com.jpmeijers.ttnmapper&rdid=com.jpmeijers.ttnmapper). Името му е **TTN Mapper**.

![](https://raw.githubusercontent.com/startupfactorybg/RuseLoRaWAN/master/Images/TTNMapper.png)

_Фигура 6_

 - Модел на свързванене на компонентите на тракера:

![](https://raw.githubusercontent.com/startupfactorybg/RuseLoRaWAN/master/Schematics/SignalTracker/SignalTracker_bb.png)

_Фигура 7_
 
 - Електрическа схема на тракера:

![](https://raw.githubusercontent.com/startupfactorybg/RuseLoRaWAN/master/Schematics/SignalTracker/SignalTracker_schem.png)

_Фигура 8_

#### **Проби**
 - Пробите се извършват след предварително работещ LoRa Gate.
 - В случай, че решите да извършите offline проби или проби без LoRa gate тогава, трябва да следвате документацията от [**този пример**](https://learn.adafruit.com/adafruit-feather-32u4-radio-with-lora-radio-module?view=all).

#### **Задачи**
 - 1. Да се приспива устройството за 15 минути и на всяко събуждане да изпраща по едно измерване.

#### **Решения**
 - За решаване на първа задача един от вариантите е, да се използва EEPROM паметта, в която да се записва броят на събужданията и така да се създаде отложен старт.
 - Друг възможен вариант е да се използва външен събуждащ механизъм [**например**](https://learn.adafruit.com/adafruit-tpl5110-power-timer-breakout/). Този препрограмируем таймер с отложен старт ще помогне да се намалят броят на записите в EEPROM и да се управлява устройството сигурно. Многократното (периодично) записване в EEPROM паметта на устройството би скъсило значително живота на тази памет. Което би оскъпило устройството за поддръжка. С този модул се оскъпява еднократно и живота му се увеличва многократно. Като в този случай живота му се свежда до живота на батерията.